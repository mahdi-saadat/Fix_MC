<script>
// Hoek-Brown calculation
function hoekBrown(sig3, sigC, m, s, a) {
    return sig3 + sigC * Math.pow(m * (sig3 / sigC) + s, a);
}

// Mohr-Coulomb calculation (returns σ1, phi, and c)
function mohrCoulomb(sig3, sigma_3, sigC, m, s, a) {
    const nfi = 1 + a * m * Math.pow(m * (sigma_3 / sigC) + s, a - 1); // Factor
    const c = 1 / (2 * Math.sqrt(nfi)) * (((1 - nfi) * sigma_3) + (sigC * Math.pow(m * (sigma_3 / sigC) + s, a))); // Cohesion
    const phi = (2 * Math.atan(Math.sqrt(nfi)) - Math.PI / 2) * (180 / Math.PI); // Friction Angle in degrees
    const sig1 = nfi * sig3 + 2 * c * Math.sqrt(nfi); // σ1 calculation
    return { sig1, c, phi }; // Return all needed values
}

// Function to run calculations and update the plot
function runCalculations() {
    // Retrieve user inputs
    const UCSi = parseFloat(document.getElementById("UCSi").value);
    const GSI = parseFloat(document.getElementById("GSI").value);
    const mi = parseFloat(document.getElementById("mi").value);
    const D = parseFloat(document.getElementById("D").value);
    const density = parseFloat(document.getElementById("density").value);
    const depth = parseFloat(document.getElementById("depth").value);

    // Overburden pressure (sigma_3)
    const sigma_3 = calculateSigma3(density, depth);

    // Hoek-Brown parameters
    const mb = mi * Math.exp((GSI - 100) / 28 - 14 * D);
    const s = Math.exp((GSI - 100) / 9 - 3 * D);
    const a = 0.5 + (1 / 6) * (Math.exp(-GSI / 15) - Math.exp(-20 / 3));
    const sigt = calculateTensileStrength(UCSi, mb, s);

    // Generate sigma3 values
    const sig3Values = generateSigma3Values(sigt, 1.2, sigma_3, 500);

    // Simplify the x-axis data points for better rendering
    const reducedSig3Values = reduceData(sig3Values, 10);

    // Calculate sig1 values
    const sig1HB = reducedSig3Values.map(sig3 => hoekBrown(sig3, UCSi, mb, s, a));
    const sig1MC = [];
    let cohesion, frictionAngle; // To store MC parameters

    reducedSig3Values.forEach(sig3 => {
        const { sig1, c, phi } = mohrCoulomb(sig3, sigma_3, UCSi, mb, s, a); // Destructure results
        sig1MC.push(sig1); // Push σ1 for plotting
        cohesion = c; // Update cohesion (consistent for given parameters)
        frictionAngle = phi; // Update friction angle
    });

    // Update results display
    document.getElementById("hbParams").innerText = `mb = ${mb.toFixed(2)}, s = ${s.toFixed(4)}, a = ${a.toFixed(3)}`;
    document.getElementById("mcParams").innerText = `c = ${cohesion.toFixed(2)} MPa, Friction Angle = ${frictionAngle.toFixed(2)}°`;

    // Destroy and redraw the chart
    if (chart) chart.destroy();

    chart = new Chart(document.getElementById("failurePlot").getContext("2d"), {
        type: "line",
        data: {
            labels: reducedSig3Values,
            datasets: [
                { label: "Hoek-Brown", data: sig1HB, borderColor: "red", borderWidth: 2, fill: false },
                { label: "Mohr-Coulomb", data: sig1MC, borderColor: "blue", borderWidth: 2, fill: false }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            aspectRatio: 1.5,
            scales: {
                x: {
                    title: { display: true, text: "σ3 (MPa)", font: { size: 14, weight: "bold" } },
                    ticks: { autoSkip: true, maxTicksLimit: 15, font: { size: 12 } },
                    grid: { color: "#e0e0e0" }
                },
                y: {
                    title: { display: true, text: "σ1 (MPa)", font: { size: 14, weight: "bold" } },
                    ticks: { font: { size: 12 } },
                    grid: { color: "#e0e0e0" }
                }
            },
            plugins: {
                legend: { position: "top", labels: { font: { size: 14 } } }
            },
            elements: { point: { radius: 0 }, line: { tension: 0.1 } }
        }
    });
}

// Perform initial calculations on page load
runCalculations();
</script>